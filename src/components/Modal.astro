---
interface Detail {
	label: string;
	value: string;
}

interface Props {
	id: string;
	title: string;
	image: string;
	icon?: string;
	details?: Detail[];
}

const { id, title, image, icon, details } = Astro.props;
---

<div class="modal-overlay" id={id} role="dialog" aria-modal="true" aria-labelledby={`${id}-title`} aria-hidden="true">
	<div class="modal-content">
		<div class="modal-header">
			<img src={image} alt={title} class="modal-header-image"/>
			<button class="modal-close" data-close={id} aria-label="Cerrar modal">✕</button>
		</div>
		<div class="modal-body">
			<h2 class="modal-title" id={`${id}-title`}>
				{icon && <i class={`bi bi-${icon}`}></i>}{title}
			</h2>
			<slot />
			{details && details.length > 0 && (
				<div class="modal-details">
					{details.map((detail) => (
						<div class="detail-item">
							<div class="detail-label">{detail.label}</div>
							<div class="detail-value">{detail.value}</div>
						</div>
					))}
				</div>
			)}
		</div>
	</div>
</div>

<style>
	.modal-overlay {
		display: none;
		position: fixed;
		inset: 0;
		background: rgba(0, 0, 0, 0.48);
		backdrop-filter: blur(8px);
		-webkit-backdrop-filter: blur(8px);
		z-index: 2000;
		align-items: center;
		justify-content: center;
		padding: 1rem;
		animation: overlayIn 240ms cubic-bezier(0.16, 1, 0.3, 1);
	}

	.modal-overlay.active {
		display: flex;
	}

	.modal-content {
		background: white;
		border-radius: 10px;
		max-width: 520px;
		width: 100%;
		max-height: min(65vh, calc(100vh - 2rem));
		display: flex;
		flex-direction: column;
		overflow: hidden;
		position: relative;
		animation: modalSlideIn 260ms cubic-bezier(0.16, 1, 0.3, 1) both;
		box-shadow: 
			0 20px 25px rgba(0, 0, 0, 0.08),
			0 8px 10px rgba(0, 0, 0, 0.04),
			0 0 1px rgba(0, 0, 0, 0.02);
		border: 1px solid rgba(0, 0, 0, 0.04);
		will-change: transform, opacity;
	}

	:global(html.dark) .modal-content {
		background: #1f2937;
		border: 1px solid rgba(255, 255, 255, 0.1);
		box-shadow: 0 20px 25px rgba(0, 0, 0, 0.2);
	}

	.modal-content::before {
		content: '';
		position: absolute;
		inset: 0;
		border-radius: inherit;
		pointer-events: none;
		box-shadow: 
			inset 0 1px 0 rgba(255, 255, 255, 0.8),
			inset 0 -1px 0 rgba(0, 0, 0, 0.02);
		z-index: 1;
	}

	.modal-header {
		position: relative;
		width: 100%;
		height: 180px;
		background: linear-gradient(135deg, #0d47a1 0%, #1565c0 50%, #0277bd 100%);
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 4rem;
		border-radius: 6px 6px 0 0;
		overflow: hidden;
		border: none;
		box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.2);
	}

	.modal-header-image {
		width: 100%;
		height: 100%;
		object-fit: cover;
		padding: 0;
	}

	.modal-header::after {
		content: '';
		position: absolute;
		inset: 0;
		background: radial-gradient(circle at 100% 0%, rgba(255, 255, 255, 0.2), transparent 70%);
		pointer-events: none;
	}

	.modal-close {
		position: absolute;
		top: 0.75rem;
		right: 0.75rem;
		background: rgba(255, 255, 255, 0.92);
		border: 1px solid rgba(0, 0, 0, 0.06);
		border-radius: 6px;
		width: 40px;
		height: 40px;
		cursor: pointer;
		font-size: 1.25rem;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 200ms cubic-bezier(0.16, 1, 0.3, 1);
		z-index: 2002;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
		font-weight: 300;
		color: #333;
	}

	:global(html.dark) .modal-close {
		background: rgba(31, 41, 55, 0.9);
		color: #f3f4f6;
		border-color: rgba(255, 255, 255, 0.1);
	}

	.modal-close:hover {
		background: white;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
		border-color: rgba(0, 0, 0, 0.1);
		transform: scale(1.05);
	}

	:global(html.dark) .modal-close:hover {
		background: #374151;
		border-color: rgba(255, 255, 255, 0.2);
	}

	.modal-close:active {
		transform: scale(0.98);
		box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
	}

	.modal-close:focus-visible {
		outline: 2px solid #0d47a1;
		outline-offset: 2px;
	}

	.modal-body {
		padding: 1.5rem;
		flex: 1 1 auto;
		overflow: auto;
		-webkit-overflow-scrolling: touch;
		scrollbar-width: thin;
		scrollbar-color: rgba(0, 0, 0, 0.1) transparent;
	}

	.modal-body::-webkit-scrollbar {
		width: 6px;
	}

	.modal-body::-webkit-scrollbar-track {
		background: transparent;
	}

	.modal-body::-webkit-scrollbar-thumb {
		background: rgba(0, 0, 0, 0.1);
		border-radius: 3px;
		transition: background 200ms;
	}

	.modal-body::-webkit-scrollbar-thumb:hover {
		background: rgba(0, 0, 0, 0.2);
	}

	:global(html.dark) .modal-body::-webkit-scrollbar-thumb {
		background: rgba(255, 255, 255, 0.2);
	}

	.modal-title {
		font-size: 1.4rem;
		margin: 0 0 0.75rem 0;
		color: #1a1a1a;
		display: flex;
		align-items: center;
		gap: 0.75rem;
		font-weight: 600;
		letter-spacing: -0.3px;
		line-height: 1.3;
	}

	:global(html.dark) .modal-title {
		color: #f3f4f6;
	}

	/* Estilos para el contenido inyectado vía slot */
	.modal-body :global(.modal-description) {
		color: #555;
		line-height: 1.6;
		margin-bottom: 1rem;
		font-size: 0.95rem;
	}

	:global(html.dark) .modal-body :global(.modal-description) {
		color: #d1d5db;
	}

	.modal-body :global(.modal-description:last-of-type) {
		margin-bottom: 0;
	}

	.modal-details {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
		gap: 1rem;
		margin-top: 1.5rem;
		padding-top: 1.5rem;
		border-top: 1px solid #f0f0f0;
	}

	:global(html.dark) .modal-details {
		border-top: 1px solid rgba(255, 255, 255, 0.1);
	}

	.detail-item {
		text-align: center;
		padding: 0;
		transition: all 200ms ease;
		cursor: default;
	}

	.detail-item:hover {
		transform: translateY(-2px);
	}

	.detail-label {
		font-size: 0.65rem;
		color: #0d47a1;
		text-transform: uppercase;
		margin-bottom: 0.5rem;
		font-weight: 700;
		letter-spacing: 0.8px;
		display: block;
	}

	:global(html.dark) .detail-label {
		color: #60a5fa;
	}

	.detail-value {
		font-size: 1.25rem;
		font-weight: 700;
		color: #1a1a1a;
		display: block;
	}

	:global(html.dark) .detail-value {
		color: #f3f4f6;
	}

	@keyframes overlayIn {
		from { opacity: 0; }
		to { opacity: 1; }
	}

	@keyframes modalSlideIn {
		0% {
			opacity: 0;
			transform: translateY(16px) scale(0.97);
		}
		100% {
			opacity: 1;
			transform: translateY(0) scale(1);
		}
	}

	@media (max-width: 720px) {
		.modal-content {
			width: 95%;
			max-height: 95vh;
		}

		.modal-header {
			height: 250px;
			font-size: 4rem;
		}

		.modal-body {
			padding: 1.5rem;
		}

		.modal-title {
			font-size: 1.5rem;
		}
	}

	@media (max-width: 480px) {
		.modal-header {
			height: 200px;
			font-size: 3rem;
		}

		.modal-body {
			padding: 1rem;
		}

		.modal-details {
			grid-template-columns: 1fr;
		}
	}
</style>

<script is:inline>
// Manejo global de modales.
// Abrir: elemento con [data-modal="<id>"]
// Cerrar: elemento con [data-close="<id>"], clic en el overlay o tecla ESC
(() => {
	const ACTIVE = 'active';

	const getModal = (id) => {
		if (!id) return null;
		const m = document.getElementById(id);
		return m && m.classList.contains('modal-overlay') ? m : null;
	};

	const openModal = (id) => {
		const m = getModal(id);
		if (!m) return;
		m.classList.add(ACTIVE);
		m.setAttribute('aria-hidden', 'false');
		document.documentElement.style.overflow = 'hidden';
		// Foco accesible
		const focusable = m.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
		if (focusable) focusable.focus();
	};

	const closeModal = (id) => {
		const m = getModal(id);
		if (!m) return;
		m.classList.remove(ACTIVE);
		m.setAttribute('aria-hidden', 'true');
		document.documentElement.style.overflow = '';
	};

	const closeAllModals = () => {
		document.querySelectorAll('.modal-overlay.active').forEach((m) => closeModal(m.id));
	};

	// Exponer helpers para scripts externos (p. ej. navegación en galería)
	if (typeof window !== 'undefined') {
		window.__modalHelpers = { openModal, closeModal, closeAllModals };
	}

	// Captura de clics delegada
	document.addEventListener('click', (e) => {
		// Abrir modal
		const openTrigger = e.target.closest('[data-modal]');
		if (openTrigger && !e.target.closest('.modal-overlay')) {
			openModal(openTrigger.getAttribute('data-modal'));
			return;
		}

		// Cerrar con botón [data-close]
		const closeTrigger = e.target.closest('[data-close]');
		if (closeTrigger) {
			closeModal(closeTrigger.getAttribute('data-close'));
			return;
		}

		// Cerrar al hacer clic directamente en el overlay (fondo oscuro)
		if (e.target.classList.contains('modal-overlay')) {
			closeModal(e.target.id);
		}
	});

	// Cerrar con ESC
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') closeAllModals();
	});
})();
</script>
